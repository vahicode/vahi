pavi# VaHI API Routes

VaHI v1 had a seperate frontend and backend REST API. In v2, I have merged both
into a single NextJS instace. In combination with switching from mongodb to 
sqlite, this makes it much easier to deploy.

As such, there is no dedicated REST API, but there are API routes in the 
application which might be useful for people trying to automate certain things.
For this reason, they are documented below.

## Table of contents

- [Authentication](#authentication)
  - [API Authentication](#api-authentication)
  - [POST /api/user-login](#post-apiuser-login)
  - [POST /api/admin-login](#post-apiadmin-login)
- [Admins](#admins)
  - [POST /api/admins/add](#post-apiadminsadd)
  - [GET /api/admins/get/{email}](#get-apiadminsgetemail)
  - [DELETE /api/admins/delete/{email}](#delete-apiadminsdeleteemail)
  - [PUT /api/admins/activate](#put-apiadminsactivate)
  - [PUT /api/admins/deactivate](#put-apiadminsdeactivate)
  - [PUT /api/admins/notes](#put--apiadminsnotes)
  - [PUT /api/admins/role](#put-apiadminsrole)
  - [GET /api/admins](#get-apiadmins)
- [Users](#users)
  - [POST /api/users/add](#post-apiusersadd)
  - [GET /api/users/get/{invite}](#get-apiusersgetinvite)
  - [DELETE /api/users/delete/{invite}](#delete-apiusersdeleteinvite)
  - [PUT /api/users/activate](#put-apiusersactivate)
  - [PUT /api/users/deactivate](#put-apiusersdeactivate)
  - [PUT /api/users/demo](#put-apiusersdemo)
  - [PUT /api/users/notes](#put-apiusersnotes)
  - [GET /api/users](#get-apiusers)
- [Eyes](#eyes)
  - [POST /api/eyes/upload](#post-apieyesupload)
  - [GET /api/eyes/get/{id}](#get-apieyesgetid)
  - [DELETE /api/eyes/delete/{id}](#delete-apieyesdeleteid)
  - [PUT /api/eyes/activate](#put-apieyesactivate)
  - [PUT /api/eyes/deactivate](#put-apieyesdeactivate)
  - [PUT /api/eyes/calibrate](#put-apieyescalibrate)
  - [PUT /users/eyes/notes](#put-userseyesnotes)
  - [GET /api/eyes](#get-apieyes)
  - [GET /api/img/eyes/{id}](#get-apiimgeyesid)
- [Grades](#grades)
  - [GET /api/grading/load](#get-apigradingload)
  - [POST /api/grading/save](#post-apigradingsave)
  - [GET /api/grades/get/{id}](#get-apigradesgetid)
  - [GET /api/grades](#get-apigrades)


## Authentication

Authentication on API routes is based on [JSON web tokens](https://jwt.io) (JWT).
This is the case for both regular users (with an invite code) as for 
administrators (with username and password).

Any of the login routes (for users or admins, see below) will return a JWT.
For subsequent API calles, pass it prefixed by `Bearer ` in the 
`Authorization` header, like this:

```
Authorization Bearer eyJhbGci...
```

### POST /api/user-login

Allows users (people with an invite code) to login.
Returns a JWT token for subsequent calls to API routes.

> This API route requires no authentication

Request body example:

```json
{
  "invite": "demo"
}
```

Return body example:

```json
{
  "token": "eyJhbG[truncated...]",
  "user": {
    "id":"demo",
    "createdAt": "2022-04-24T15:21:08.302Z",
    "createdBy": "root@vahi.eu",
    "isDemoUser": true,
    "isActive": true,
    "lastLogin": "2022-04-24T20:02:20.872Z",
    "notes": "Demo user generated by the initial database seed script"
  }
}
```

### POST /api/admin-login

Allows admins (people with a username and password) to login.
Returns a JWT token for subsequent calls to API routes.

> This API route requires no authentication

Request body example:

```json
{
  "username": "admin username here",
  "password": "admin password here"
}
```

Return body example:

```json
{
  "token": "eyJhbG[truncated...]",
  "admin": {
    "email": "root@vahi.eu",
    "createdAt": "2022-04-24T15:21:08.295Z",
    "createdBy": "root@vahi.eu",
    "notes": "Superadmin generated by the initial datbase seed script",
    "isActive": true,
    "lastLogin": "2022-04-24T15:28:29.829Z",
    "role": "superadmin"
  }
}
```

## Admins

An admin is a person who has access to the administrative pages.
Admins have a username and password, unlike regular users who only
have an invite code to authenticate.

> **Note**: The username of an admin is stored in a field named `email`.
> Strictly speaking, there is no need for this to be an actual email address
> (in other words, `joost` works just as well) since VaHI does not send out
> any emails.

Admins can have one of the following roles:

- `analyst`: Allows access to & exporting data
- `dataentry`: Grants permission on pictures and eyes
- `admin`: Grants all access except to other admins
- `superadmin`: Grants all access

### POST /api/admins/add

Adds a new admin account. 

> This API route requires the `superadmin` role

Request body example:

```json
{
  "email": "intern@vahi.eu",
  "notes": "This is the intern admin account"
}
```

Return body example:

```json
{
  "email": "intern@vahi.eu",
  "createdAt": "2022-04-24T11:52:33.829Z",
  "createdBy": "root@vahi.eu",
  "notes": "This is the intern admin account",
  "password": "L;s1N#3TeS*0GuYPzW76hN@lCsmFV<g1N]6JUA)<bJ",
  "isActive": false,
  "role": "analyst",
  "lastLogin": null
}
```

### GET /api/admins/get/{email}

Retrieves the record of the admin account of which the `email` was passed in the URL.

> This API route requires the `superadmin` role

Return body example:

```
{
  "email": "root@vahi.eu",
  "createdAt": "2022-04-24T11:52:33.829Z",
  "createdBy": "root@vahi.eu",
  "isActive": true,
  "notes": "Superadmin generated by the initial datbase seed script",
  "role": "superadmin",
  "lastLogin ":"2022-04-24T15:55:51.368Z"
}
```

### DELETE /api/admins/delete/{email}

Removes the record of the admin account of which the `email` was passed in the URL.

> This API route requires the `superadmin` role

Return body example:

```json
{
  "removed": "joost@joost.at"
}
```

### PUT /api/admins/activate

Activates (enables) one or more admin accounts.

> This API route requires the `superadmin` role

Request body example:

```json
{
  "admins": [
    "joost@joost.at"
  ]
}
```

> **Tip**: You can supply multiple emails in the request body.

Return body example:

```json
{
  "status": "ok"
}
```

### PUT /api/admins/deactivate

Deactivates (disables) one or more admin accounts.

> This API route requires the `superadmin` role

Request body example:

```json
{
  "admins": [
    "joost@joost.at"
  ]
}
```

> **Tip**: You can supply multiple emails in the request body.

Return body example:

```json
{
  "status": "ok",
  "removed": [
    "joost@joost.at"
  ],
  "danger": false
}
```

The **danger** return parameter will be `true` only if you try to disable the
admin account that was used to authenticate the API call (in other words,
your own account).

In such a case the return body will look like this:

```json
{
  "status": "ok",
  "removed": [],
  "danger": true
}
```

### PUT /api/admins/notes

Updates the **notes** of an admin account.

> This API route requires the `superadmin` role

Request body example:

```json
{
  "admin": "root@vahi.eu",
  "notes": "These are the notes"
}
```

Return body example:

```json
{
  "email": "root@vahi.eu",
  "createdAt": "2022-04-24T11:52:33.829Z",
  "createdBy": "root@vahi.eu",
  "isActive": true,
  "notes": "These are the notes",
  "role": "superadmin",
  "lastLogin ":"2022-04-24T15:55:51.368Z"
}
```

### PUT /api/admins/role

Updates the **role** of an admin account.

> This API route requires the `superadmin` role

Request body example:

```json
{
  "admin": "joost@joost.at",
  "role": "admin"
}
```

Return body example:

```json
{
  "email": "joost@joost.at",
  "createdAt": "2022-04-24T11:52:33.829Z",
  "createdBy": "root@vahi.eu",
  "isActive": true,
  "notes": "Just some example notes",
  "role": "admin",
  "lastLogin ":"2022-04-24T15:55:51.368Z"
}
```

### GET /api/admins

Returns a list of admin accounts. 

> This API route requires the `admin` or `superadmin` role

Return body example:

```json
[
  {
    "email": "root@vahi.eu",
    "createdAt": "2022-04-24T11:52:33.829Z",
    "createdBy": "root@vahi.eu",
    "notes": "Superadmin generated by the initial datbase seed script",
    "isActive": true,
    "lastLogin": "2022-04-24T15:55:51.368Z",
    "role": "superadmin"
  },
  { 
    "email": "test@vahi.eu",
    "createdAt": "2022-04-24T16:20:37.723Z",
    "createdBy": "root@vahi.eu",
    "notes": "tyest",
    "isActive": false,
    "lastLogin": null,
    "role": "analyst"
  }
]
```

## Users

A user is a person with an invite code who can grade eyes. 

> **Note**: Users that have `isDemoUser` set to
> `true` can grade eyes but their grades will not be stored in the database.

### POST /api/users/add

Adds one or more new user account.

> This API route requires the `admin` or `superadmin` role

> **Note**: The amount of users you can created in a single request is capped at `100`

Request body example:

```json
{
  "count": 2,
  "notes": "This are the notes",
}
```

Return body example:

```json
[
  "F7N7yM8fVhravBTdKPzY8BCj9fwSWjNR",
  "5vJDpFFq42SyBZdca89xqyDPTN6eHjpX"
]
```

### GET /api/users/get/{invite}

Retrieves the record of the user account of which the `id` (the invite code) was passed in the URL.

> This API route requires the `admin` or `superadmin` role

Return body example:

```
{
  "id": "PFSV6czxgXYzbakwdwtpj5spYLUkT25n",
  "createdAt": "2022-04-24T13:19:11.890Z",
  "createdBy": "root@vahi.eu",
  "isDemoUser": false,
  "isActive": true,
  "lastLogin": "2022-04-24T13:19:23.890Z",
  "notes": "Test joost"
}
```

### DELETE /api/users/delete/{invite}

Removes the record of the user account of which the `id` (the invite code) was passed in the URL.

> This API route requires the `admin` or `superadmin` role

Return body example:

```json
{
  "removed": "PFSV6czxgXYzbakwdwtpj5spYLUkT25n"
}
```

### PUT /api/users/activate

Activates (enables) one or more user accounts.

> This API route requires the `admin` or `superadmin` role

Request body example:

```json
{
  "users": [
    "58LayUh5ssakPPYTHMUC6hzvks6XEMqL"
  ]
}
```

> **Tip**: You can supply invite codes in the request body.

Return body example:

```json
{
  "status": "ok"
}
```

### PUT /api/admins/deactivate

> This API route requires the `admin` or `superadmin` role

Deactivates (disables) one or more user accounts.

Request body example:

```json
{
  "users": [
    "58LayUh5ssakPPYTHMUC6hzvks6XEMqL"
  ]
}
```

> **Tip**: You can supply multiple emails in the request body.

Return body example:

```json
{
  "status": "ok"
}
```

### PUT /api/users/demo

Updates the **isDemoUser** field of a user account.

> This API route requires the `admin` or `superadmin` role

> **Tip**: Demo users can grade eyes but their grades won't be stored

Request body example:

```json
{
  "user": "PFSV6czxgXYzbakwdwtpj5spYLUkT25n",
  "demo": true
}
```

Return body example:

```json
{
  "id": "PFSV6czxgXYzbakwdwtpj5spYLUkT25n",
  "createdAt": "2022-04-24T13:19:11.890Z",
  "createdBy": "root@vahi.eu",
  "isDemoUser": true,
  "isActive": true,
  "lastLogin": "2022-04-24T13:19:23.890Z",
  "notes": "These are the notes"
}
```

### PUT /api/users/notes

Updates the **notes** of a user account.

> This API route requires the `admin` or `superadmin` role

Request body example:

```json
{
  "admin": "58LayUh5ssakPPYTHMUC6hzvks6XEMqL",
  "notes": "These are the notes"
}
```

Return body example:

```json
{
  "id": "PFSV6czxgXYzbakwdwtpj5spYLUkT25n",
  "createdAt": "2022-04-24T13:19:11.890Z",
  "createdBy": "root@vahi.eu",
  "isDemoUser": false,
  "isActive": true,
  "lastLogin": "2022-04-24T13:19:23.890Z",
  "notes": "These are the notes"
}
```

### GET /api/users

Returns a list of user accounts. 

> This API route requires the `admin` or `superadmin` role

Return body example:

```json
[
  {
    "id": "demo",
    "createdAt":
    "2022-04-24T11:52:33.851Z",
    "createdBy": "root@vahi.eu",
    "isDemoUser": true,
    "isActive": true,
    "lastLogin": "2022-04-24T16:01:24.070Z",
    "notes": "Demo user generated by the initial database seed script",
    "graded": 0
  },
  {
    "id": "58LayUh5ssakPPYTHMUC6hzvks6XEMqL",
    "createdAt": "2022-04-27T18:21:58.421Z",
    "createdBy": "root@vahi.eu",
    "isDemoUser": true,
    "isActive": false,
    "lastLogin": null,
    "notes": "test",
    "graded":0
  }
]
```

## Images

The Images table holds pictures of eyes. They are stored in the database 
as binary blobs, which makes backing up VaHI trivial as you only need to
copy a single file.

Each eye is associated with two images:

 - The `vimg` is used to grade vascularity and haze, and is typically a 
 regular picture of an eye
 - The `iimg` is used to grade integrity, and is typically a blue-filter
 picture of an eye

### POST /api/img/add/vimg

Adds and image to rate vascularity and haze.

> This API route requires the `dataentry`, `admin`, or `superadmin` role

This API endpoint expects a request body of type `multipart/form-data`, 
in other words a traditional file upload.

It also does not return JSON but rather the body only contains the ID of
the newly added images. That's because we 
use [FilePond](https://pqina.nl/filepond/) in the UI to handle the upload
and it's the return it expects.

Request body example:

```
-----------------------------383819189136243639171977583521
Content-Disposition: form-data; name="vimg"
{"color":null}
Content-Disposition: form-data; name="vimg"; filename="eye4.jpg"
Content-Type: image/jpeg
ÿØÿà••JFIF••• 
[...truncated]
```

Return body example:

```
10
```

### POST /api/img/add/iimg

Adds and image to rate integrity.

> This API route requires the `dataentry`, `admin`, or `superadmin` role

This API endpoint expects a request body of type `multipart/form-data`, 
in other words a traditional file upload.

It also does not return JSON but rather the body only contains the ID of
the newly added images. That's because we 
use [FilePond](https://pqina.nl/filepond/) in the UI to handle the upload
and it's the return it expects.

Request body example:

```
-----------------------------383819189136243639171977583521
Content-Disposition: form-data; name="iimg"
{"color":null}
Content-Disposition: form-data; name="iimg"; filename="eye5.jpg"
Content-Type: image/jpeg
ÿØÿà••JFIF••• 
[...truncated]
```

Return body example:

```
11
```

### PUT /api/img/calibrate

Updates the **calibration data** of an eye (picture) which controls the
position of the grid on the picture.

> **Tip**: The calibration data consists of:
>
> - `scale`: The scale of the grid
> - `x`: The anchor of the grid on the X-axis
> - `y`: The anchor of the grid on the Y-axis

This is only relevant for images used to grade vascularity/haze.

> This API route requires the `dataentry`, `admin`, or `superadmin` role

Request body example:

```json
{
  "image": 9,
  "scale": 0.81,
  "x": "-67.25",
  "y": "-19"
}
```

Return body example:

```json
{
  "id":9,
  "createdAt": "2022-05-09T14:32:04.141Z",
  "createdBy": "root@vahi.eu",
  "integrity": false,
  "img": {
    "type": "Buffer",
    "data": [ 60,115,118,103,... ]
  },
  "scale": 0.81,
  "x": -67.25,
  "y": -19,
  "width": 283,
  "height":64, 
  "mimetype": "image/jpeg",
  "vEyeId": 5,
  "iEyeId": null
}
```

> **Note**: This will not return the (binary) image data. See the next API
route for info on how to retrieve the image itself.

### GET /api/img/[id]

Returns the binary picture data of the image of which the `id` was passed
in the URL. This API route requires not authentication and its
purpose is serve up images for use in html. For example in an img tag:

> **Tip**: This does not return JSON but the raw binary image data.
> In other words, you can use this as the `src` in an `img` tag.

```html
<img src="/api/img/12" />
```

## Eyes

An eye is what users grade. 

### POST /api/eyes/add

Adds a new eye record.

> This API route requires the `dataentry`, `admin`, or `superadmin` role

Request body example:

```json
{
  "iimg": 12,
  "vimg": 13,
  "notes": "These are the eye notes"
}
```

Return body example:

```json
{
  "id": 4,
  "createdAt": "2022-05-09T14:01:03.857Z",
  "createdBy": "root@vahi.eu",
  "isActive": false,
  "notes": "These are the eye notes"
}
```

> **Tip**: The `vimg` and `iimg` fields should hold the ID of a record in the Image table

### GET /api/eyes/get/{id}

Retrieves the record of the eye of which the `id` was passed in the URL.

> This API route requires the `dataentry`, `admin`, or `superadmin` role

Return body example:

```
{
  "id":4,
  "createdAt": "2022-05-09T14:01:03.857Z",
  "createdBy": "root@vahi.eu",
  "isActive": false,
  "notes": "These are the eye notes",
  "vImg": {
    "id": 7,
    "scale": 1,
    "x": 0,
    "y": 0,
    "mimetype": "image/jpeg",
    "width": 1280,
    "height": 720
  },
  "iImg": {
    "id": 8
  },
  "grades":0
}
```

### DELETE /api/eyes/delete/{id}

Removes the record of the eye of which the `id` was passed in the URL.

> This API route requires the `dataentry`, `admin`, or `superadmin` role

Return body example:

```json
{
  "removed": 4
}
```

### PUT /api/eyes/activate

Activates (enables) one or more (pictures of) eyes.

> This API route requires the `dataentry`, `admin`, or `superadmin` role

Request body example:

```json
{
  "eyes": [ 1 ]
}
```

> **Tip**: You can supply multiple eye IDs in the request body.

Return body example:

```json
{
  "status": "ok"
}
```

### PUT /api/eyes/deactivate

Deactivates (disables) one or more (pictures of) eyes.

> This API route requires the `dataentry`, `admin`, or `superadmin` role

Request body example:

```json
{
  "eyes": [ 1 ]
}
```

> **Tip**: You can supply multiple ids in the request body.

Return body example:

```json
{
  "status": "ok"
}
```

### PUT /api/eyes/notes

Updates the **notes** of an eye record.

Request body example:

```json
{
  "eye": 1,
  "notes": "These are the notes"
}
```

Return body example:

```json
{
  "id": 1,
  "createdAt": "2022-04-24T12:00:17.731Z",
  "createdBy": "root@vahi.eu",
  "isActive": false,
  "notes": "These are the notes",
  "scale": 0.73,
  "x": 144,
  "y": 2.75,
  "mimetype": "image/jpeg",
  "width":1200,
  "height":921
}
```

### GET /api/eyes

Returns a list of eyes.

Return body example:

```json
[
  {
    "id": 1,
    "createdAt": "2022-04-24T12:00:17.731Z",
    "createdBy": "root@vahi.eu",
    "isActive": false,
    "notes": "These are the notes",
    "scale": 0.73,
    "x": 144,
    "y": 2.75,
    "mimetype": "image/jpeg",
    "width":1200,
    "height":921
  }
]
```

## Grades

The grades are (a set of) scores assigned to an eye by a user.

For vascularity and haze, each eye has 13 zones, and for each zone we store a 
score from 0 to 3.  
For integrity, there's a single score for the entire eye from 0 to 3.

### GET /api/grading/load

Loads the next eye to grade, as well as some data about the grading progress.

Return body example:

```json
{
  "stats": {
    "total": 5,
    "todo": 5,
    "done": 0
  },
  "eye": {
    "id": 1,
    "vImg": {
      "id": 1,
      "scale": 0.73,
      "x": 132,
      "y": 16.25,
      "mimetype": "image/jpeg",
      "width": 1200,
      "height": 921
    },
    "iImg": {
      "id":2,
      "width": 1200,
      "height": 907
    }
  }
}
```

If the user has graded all eyes, the return will not include an eye record:

```json
{
  "stats": {
    "total": 5,
    "todo": 0,
    "done": 5
  },
  "eye": false
}
```

### POST /api/grading/save

Stores a user's grading for a particular eye.

Request body example:

```json
{
  "eye": 1,
  "grades": {
    "vascularity": {
      "1": 1,
      "2": 1,
      "3": 0,
      "4": 1,
      "5": 2,
      "6": 1,
      "7": 2,
      "8": 3,
      "9": 2,
      "10": 2,
      "11": 1,
      "12": 0,
      "13": 0
    },
    "haze": {
      "1": 0,
      "2": 0,
      "3": 1,
      "4": 1,
      "5": 0,
      "6": 1,
      "7": 0,
      "8": 1,
      "9": 2,
      "10": 1,
      "11": 0,
      "12": 0,
      "13": 0
    },
    "integrity": 1
  }
}
```

This API route will have the same return as `/api/grading/load`; In other words
the next eye to grade. Returning it here saves us an round-trip.

See above for an example.

### GET /api/grades/get/{id}

Retrieves the record of grades of which the `id` was passed in the URL.

Return body example:

```
{
  "id":1,
  "createdAt":"2022-05-05T14:38:10.299Z",
  "eyeId":1,
  "userId":"neUE2vYzWkNj7JktksJ7v67bQLjvYt64",
  "v1":1,
  "v2":1,
  "v3":1,
  "v4":1,
  "v5":1,
  "v6":1,
  "v7":1,
  "v8":1,
  "v9":2,
  "v10":2,
  "v11":2,
  "v12":2,
  "v13":3,
  "h1":1,
  "h2":0,
  "h3":0,
  "h4":0,
  "h5":0,
  "h6":0,
  "h7":0,
  "h8":0,
  "h9":0,
  "h10":0,
  "h11":0,
  "h12":0,
  "h13":0,
  "i":2,
  "user":{
    "id":"neUE2vYzWkNj7JktksJ7v67bQLjvYt64",
    "createdAt":"2022-05-05T14:33:19.907Z",
    "createdBy":"root@vahi.eu",
    "isDemoUser":false,
    "isActive":true,
    "lastLogin":"2022-05-05T14:33:31.988Z",
    "notes":""
  },
  "eye":{
    "id":1,
    "createdAt":"2022-05-05T13:51:56.112Z",
    "createdBy":"root@vahi.eu",
    "isActive":true,
    "notes":"",
    "vImg":{
      "id":1,
      "createdAt":"2022-05-05T13:51:50.711Z",
      "createdBy":"root@vahi.eu",
      "integrity":false,
      "scale":0.73,
      "x":132,
      "y":16.25,
      "width":1200,
      "height":921,
      "mimetype":"image/jpeg",
      "vEyeId":1,
      "iEyeId":null
    },
    "iImg":{
      "id":2,
      "createdAt":"2022-05-05T13:51:54.050Z",
      "createdBy":"root@vahi.eu",
      "integrity":true,
      "scale":1,
      "x":0,
      "y":0,
      "width":1200,
      "height":907,
      "mimetype":"image/jpeg",
      "vEyeId":null,
      "iEyeId":1
    }
  }
}
```

### GET /api/grades

Retrieves the list of gradings.

Return body example:

```json
[
  {
    "id":1,
    "createdAt":"2022-05-05T14:38:10.299Z",
    "eyeId":1,
    "userId":"neUE2vYzWkNj7JktksJ7v67bQLjvYt64",
    "v1":1,
    "v2":1,
    "v3":1,
    "v4":1,
    "v5":1,
    "v6":1,
    "v7":1,
    "v8":1,
    "v9":2,
    "v10":2,
    "v11":2,
    "v12":2,
    "v13":3,
    "h1":1,
    "h2":0,
    "h3":0,
    "h4":0,
    "h5":0,
    "h6":0,
    "h7":0,
    "h8":0,
    "h9":0,
    "h10":0,
    "h11":0,
    "h12":0,
    "h13":0,
    "i":2,
    "eye":1
  }
]
```

